---
title: "Regressão linear na prática"
output: html_notebook
---

```{r warning=FALSE, echo=FALSE}
library(tidyverse)
library(broom)
library(modelr)
theme_set(theme_bw())
```

## Dados da CAPES sobre avaliação da pós-graduação

A CAPES é um órgão do MEC que tem a atribuição de acompanhar a pós-graduação na universidade brasileira. Uma das formas que ela encontrou de fazer isso e pela qual ela é bastante criticada é através de uma avaliação quantitativa a cada x anos (era 3, mudou para 4). 

Usaremos dados da penúltima avaliação da CAPES: 

```{r}
cacc_raw = read_csv("https://raw.githubusercontent.com/nazareno/ciencia-de-dados-1/master/3-Agrupamento-e-PCA/dados/capes-cacc.csv", col_types = "") %>% 
  mutate_all(funs(replace(., is.na(.), 0))) %>% 
  filter(Teses + Dissertacoes > 0)

glimpse(cacc_raw)
```

## Fatores associados com produção de artigos

Uma das maneiras de avaliar a produção dos docentes que a CAPES utiliza é quantificando a produção de artigos pelos docentes. Os artigos são categorizados em extratos ordenados (A1 é o mais alto), e separados entre artigos em conferências e periódicos. Usaremos para esse lab a produção em periódicos avaliados com A1, A2 e B1.

```{r}
cacc = cacc_raw %>% 
  mutate(producao = periodicos_A1 + periodicos_A2 + periodicos_B1) 

cacc %>% 
  ggplot(aes(x = producao)) + 
  geom_histogram(bins = 15)
```

Se quisermos modelar o efeito do tamanho do programa em termos de docentes (permanentes) na quantidade de artigos publicados, podemos usar regressão. 

*Importante*: sempre queremos ver os dados antes de fazermos qualquer modelo ou sumário: 

```{r}
cacc %>% 
  ggplot(aes(x = `Docentes permanentes`, y = producao)) + 
  geom_point()
```

Parece que existe uma relação. Vamos criar um modelo então:

```{r}
modelo1 = lm(producao ~ `Docentes permanentes`, data = cacc)

tidy(modelo1, conf.int = TRUE, conf.level = 0.95)
glance(modelo1)
summary(modelo1)
```

Para visualizar o modelo:

```{r}
cacc_augmented = cacc %>% 
  add_predictions(modelo1) 

cacc_augmented %>% 
  ggplot(aes(x = `Docentes permanentes`)) + 
  geom_line(aes(y = pred), colour = "brown") + 
  geom_point(aes(y = producao)) + 
  labs(y = "Produção do programa")

```

Se considerarmos que temos apenas uma amostra de todos os programas de pós em CC no Brasil, o que podemos inferir a partir desse modelo sobre a relação entre número de docentes permanentes e produção de artigos em programas de pós? 

-----

**EXPLICAÇÃO**: *A relação entre as variáveis é crescente, ou seja, aumentando a quantidade de docentes permanentes aumenta-se a quantidade de artigos produzidos. Mais precisamente, como conf.low = 4.269955	e conf.high = 5.356786, se aumentarmos em 1 o número de docentes estaremos aumentando entre 4 e 5 o número de artigos produzidos. É possível observar também que a reta do modelo cruza a nuvem de pontos exatamente no meio, sugerindo que não há enviezamento, pois ela não está mais acima ou mais abaixo de um conjunto de pontos. Esse modelo explica bem os dados, visto que o valor para R² foi 0.814, considerado alto. Isso signifca que o modelo baseado somente na quantidade de professores explica 81% da variância da quantidade de artigos. Por fim, o intervalo de confiança para a estimativa de Docentes permanentes é positivo e não contém o zero, portanto a estimativa do coeficiente beta é significativa (de outro modo,  o pvalor é bastante baixo, indicando a relação entre as variáveis Docentes permanentes e Produção não é ao acaso).*

-----

Algum palpite de por que a relação existe como ela existe em termos de força?

O R² alto era esperado porque é óbvio que quanto mais pesquisadores existem mais publicações os programas terão.

## Mais fatores

E se considerarmos também o número de alunos?

```{r}
cacc = cacc %>% 
  mutate(mestrados_pprof = Dissertacoes / `Docentes permanentes`, 
         doutorados_pprof = Teses / `Docentes permanentes`)

modelo2 = lm(producao ~ `Docentes permanentes` + mestrados_pprof + doutorados_pprof, data = cacc)

tidy(modelo2, conf.int = TRUE, conf.level = 0.95)
glance(modelo2)
```

Visualizar o modelo com muitas variáveis independentes fica mais difícil

```{r}
para_plotar_modelo = cacc %>% 
  data_grid(producao = seq_range(producao, 10), # Crie um vetor de 10 valores no range
            `Docentes permanentes` = seq_range(`Docentes permanentes`, 4),  
            #mestrados_pprof = seq_range(mestrados_pprof, 3),
            mestrados_pprof = median(mestrados_pprof),
            doutorados_pprof = seq_range(doutorados_pprof, 3)) %>% 
  add_predictions(modelo2)

glimpse(para_plotar_modelo)

```

```{r}
para_plotar_modelo %>% 
  ggplot(aes(x = `Docentes permanentes`, y = pred)) + 
  geom_line(aes(group = doutorados_pprof, colour = doutorados_pprof)) + 
  # facet_grid(. ~ mestrados_pprof) + 
  geom_point(data = cacc, aes(y = producao, colour = doutorados_pprof))
```

Considerando agora esses três fatores, o que podemos dizer sobre como cada um deles se relaciona com a produção de um programa de pós em CC? E sobre o modelo? Ele explica mais que o modelo 1? 

-----

**EXPLICAÇÃO**: *Pelo gráfico, vemos que quanto maior o número de doutores por professor maior será o número de artigos produzidos, havendo essa mesma relação crescente entre Docentes permanentes e produção. O R² ainda deu bastante alto, isso signifca que o modelo baseado também no número de alunos explica 84% da variância da quantidade de artigos, apenas 3% maior que o modelo anterior. O intervalo de confiança para número de mestrandos por professor inclui o 0, portanto a estimativa para essa variável não é conclusiva / significativa,. No entanto, para as outras variáveis as estimativas é conclusiva e têm relação crescente co a variável independente. Ainda segundo o modelo: se aumentarmos em 1 o número de docentes estaremos aumentando entre 3 e 4 o número de artigos produzidos, e se aumentarmos em 1 o número doutorandos estaremos aumentando entre 9 e 33 o número de artigos produzidos.*

-----

## Agora produtividade 

Diferente de medirmos produção (total produzido), é medirmos produtividade (produzido / utilizado). Abaixo, crie um modelo que investigue como um conjunto de fatores que você julga que são relevantes se relacionam com a produtividade dos programas. Ou seja: 

  * Crie uma variável produtividade baseada na produção e nos docentes permanentes
  * Crie um modelo que avalie como pelo menos 4 fatores se relacionam com a produtividade de um programa. Pode reutilizar fatores que já definimos e analizamos para produção. Mas cuidado para não incluir fatores que sejam função linear de outros já incluídos (ex: incluir A, B e um tercero C=A+B)

Produza abaixo o modelo e um texto que comente (i) o modelo, tal como os que fizemos antes, e (ii) uma comparação entre as relações que você viu nesse modelo e no anterior (de produção) e por que as relações encontradas foram diferentes (se foram).

-----

A produtividade será calculada como a divisão do número de artigos produzidos pela quantidade de docentes permanentes. 

```{r}

tem_doutorado = function(ans) {
  if (ans == "Sim") {
    return(1)
  } else {
    return(0)
  }
}

cacc = cacc %>%
  mutate(
    produtividade = producao / `Docentes permanentes`,
    #`Tem doutorado` = sapply(`Tem doutorado`, tem_doutorado),
    `Outros Periodicos` = periodicos_B2 + periodicos_B3 + periodicos_B4 + periodicos_B5 + periodicos_C
  )
```

Os fatores escolhidos são:

* Nível do programa
* Existência ou não de doutorado no programa
* Quantidade de artigos produzidos de outros nívels (de B2 a C)
* Quantidade de artigos em conferências

```{r}
modelo3 = lm(produtividade ~ `Nível` + `Tem doutorado` + `Outros Periodicos` + `Artigos em conf`, data = cacc)

tidy(modelo3, conf.int = TRUE, conf.level = 0.95)
glance(modelo3)
#plot(modelo3)
```

```{r}
# model_plot = cacc %>% 
#   data_grid(
#     `Nível` = seq_range(`Nível`, 10), 
#     `Tem doutorado`= seq_range(`Tem doutorado`, 4),
#     `Outros Periodicos` = seq_range(`Outros Periodicos`, 3),
#     `Artigos em conf` = seq_range(`Artigos em conf`, 3)) %>% 
#   add_predictions(modelo3)
# 
# model_plot %>%
#   ggplot(aes(x = `Outros Periodicos`, y = pred)) +
#   geom_line(aes(group = `Nível`, colour = `Nível`)) +
#   geom_point(aes(shape=as.factor(`Artigos em conf`)), size=3, alpha=0.3) +
#   facet_grid(. ~ as.integer(`Tem doutorado`))
```

**EXPLICAÇÃO**: *O R² foi menor que o dos outros dois modelos, diminuindo em cerca de 20%. Este modelo baseado em mais fatores explica apenas 63% da variância da produtividade. O intervalo de confiança para quantidade de artigos em outras conferências inclui o 0, portanto a estimativa para essa variável não é conclusiva / significativa. No entanto, para as outras variáveis as estimativas é conclusiva e têm relação crescente com a variável independente. Em comparação com o outro modelo, verifica-se que a existência de doutorado influencia na produtividade do programa. No modelo anterior, quanto maior o número de doutorandos por professor maior a produção do programa (enquanto que o número de mestrando não influencia). Neste modelo, de modo semalhante, a existência de doutorado no programa indica maior produtividade. Nesses dois casos, esses dois resultados já é esperado. Outra comparação que podemos fazer com os modelos anteriores é que para as variáveis dependentes escolhidas já esperava-se uma relação crescente. Por exemplo, quanto maior o número de docentes e de orientandos por docente obviamente maior será a produação do programa. Neste último modelo, contudo, as variáveis independentes têm uma relação menos óbvia com a produtividade. Espera-se que o fato de haver doutorado e um nível de programa mais alto indiquem que a produtividade seja maior. Contudo, uma relação entre a produção de artigos em revistas de níveis mais altos e a produação para outros níveis é menos óbvia. Essa relação menos óbvia pode justificar o R² mais baixo. *


```{r}
# library(glmnet)
# 
# input = cacc %>%
#     select(Nível, `Tem doutorado`, `Docentes colaboradores`, 
#            `Docentes permanentes`, `Docentes visitantes`, `Resumos em conf`, 
#            `Resumos expandidos em conf`, `Artigos em conf`, Dissertacoes, Teses, 
#            `Outros Periodicos`, orientandos_proff) %>%
#     as.matrix()
# 
# output= cacc$produtividade
# 
# cv_fit <- cv.glmnet(input, output, family = "gaussian")
# coef(cv_fit, s = "lambda.min")
# summary(cv_fit)
```

